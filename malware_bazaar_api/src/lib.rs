//! # Malware Bazaar API
//!
//! A Rust client library for interacting with the Malware Bazaar API from Spamhaus Abuse.ch.
//! This library provides types and functions to query malware samples, retrieve vendor intelligence,
//! and access code signing certificate blocklists.
//!
//! ## Modules
//!
//! - [`error`]: Error types used throughout the library
//! - [`queries`]: Query operations and response structures for the Malware Bazaar API

pub mod error;
pub mod queries;

/// Trait for fetching data from web endpoints.
///
/// This trait abstracts HTTP client implementations, allowing for different transport layers
/// (e.g., reqwest, hyper, or mock implementations for testing).
pub trait WebFetch {
    /// Fetches data from a URL with the given query parameters.
    ///
    /// # Arguments
    ///
    /// * `url` - The API endpoint URL to request
    /// * `query_params` - A HashMap of query parameter key-value pairs to send with the request
    ///
    /// # Returns
    ///
    /// Returns the response body as a string on success, or an [`error::Error`] on failure.
    ///
    /// # Errors
    ///
    /// This method can fail due to:
    /// - Network errors (connection issues, timeouts, etc.)
    /// - HTTP errors (4xx, 5xx status codes)
    /// - Response parsing errors
    fn fetch(
        &self,
        url: &str,
        query_params: std::collections::HashMap<&str, String>,
    ) -> Result<String, error::Error>;
}

/// HTTP client implementation using the reqwest library.
///
/// Provides a concrete implementation of the [`WebFetch`] trait using the blocking reqwest HTTP client.
/// This is the default HTTP client implementation for production use.
///
/// # Example
///
/// ```ignore
/// use malware_bazaar_api::{HttpReqwest, WebFetch, queries::QueryOperation};
///
/// let client = HttpReqwest::default();
/// let query = QueryOperation::Hash("hash_value".to_string());
/// ```
#[derive(Default)]
pub struct HttpReqwest;

impl WebFetch for HttpReqwest {
    fn fetch(
        &self,
        url: &str,
        query_params: std::collections::HashMap<&str, String>,
    ) -> Result<String, error::Error> {
        match reqwest::blocking::Client::new()
            .post(url)
            .form(&query_params)
            .send()
        {
            Ok(post_response) => match post_response.error_for_status() {
                Ok(resp) => match resp.text() {
                    Ok(text) => Ok(text),
                    Err(err) => Err(error::Error::from(err)),
                },
                Err(err) => Err(error::Error::from(err)),
            },
            Err(err) => Err(error::Error::from(err)),
        }
    }
}

#[cfg(test)]
mod fakers {
    use super::error::Error;
    use super::WebFetch;

    /// Mock HTTP client for testing purposes.
    ///
    /// Allows tests to inject predefined responses or errors without making actual network requests.
    /// Use the builder methods [`set_success_response`] and [`set_error_response`] to configure behavior.
    ///
    /// # Example
    ///
    /// ```ignore
    /// let fake_client = FakeHttpReqwest::default()
    ///     .set_success_response(r#"{"query_status":"ok","data":[]}"#.to_string());
    /// ```
    #[derive(Default)]
    pub struct FakeHttpReqwest {
        success_response: String,
        error_response: Option<Error>,
    }

    impl FakeHttpReqwest {
        /// Sets the success response that will be returned by the mock client.
        ///
        /// # Arguments
        ///
        /// * `response` - A JSON string representing the API response
        ///
        /// # Returns
        ///
        /// Returns self for method chaining.
        pub fn set_success_response(mut self, response: String) -> Self {
            self.success_response = response;

            return self;
        }

        /// Sets an error that will be returned by the mock client instead of a success response.
        ///
        /// # Arguments
        ///
        /// * `error` - An [`error::Error`] to return from fetch calls
        ///
        /// # Returns
        ///
        /// Returns self for method chaining.
        pub fn set_error_response(mut self, error: Error) -> Self {
            self.error_response = Some(error);

            return self;
        }
    }

    impl WebFetch for FakeHttpReqwest {
        fn fetch(
            &self,
            _: &str,
            _: std::collections::HashMap<&str, String>,
        ) -> Result<String, crate::error::Error> {
            if let Some(err) = &self.error_response {
                return Err(err.clone());
            }

            return Ok(self.success_response.clone());
        }
    }
}
